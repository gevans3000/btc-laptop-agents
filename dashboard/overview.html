<!doctype html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BTC Laptop Agents — Overview</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px}
h2{margin:0 0 12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch}
.card{border:1px solid #ddd;border-radius:12px;padding:12px 14px;min-width:260px;flex:1}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.ok{color:#0a7;font-weight:700}.warn{color:#c60;font-weight:700}.bad{color:#c00;font-weight:700}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:6px 8px;text-align:left;vertical-align:top}
button{padding:7px 10px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer}
button:hover{background:#fafafa}
small{color:#666}
</style></head><body>
<h2>BTC Laptop Agents — Overview</h2>

<div class="row">
  <div class="card">
    <div class="mono"><span id="health" class="warn">CHECKING…</span></div>
    <div class="mono">PID: <span id="pid">—</span> (<span id="running">—</span>)</div>
    <div class="mono">Paused: <span id="paused">—</span></div>
    <div class="mono">Stops at: <span id="stopAt">—</span></div>
    <div class="mono">Remaining: <span id="remain" class="ok">—</span></div>
    <div class="mono" style="margin-top:8px">
      <a href="/dashboard/" target="_blank">dashboard</a> |
      <a href="/dashboard/monitor.html" target="_blank">monitor</a> |
      <a href="/logs/live_paper.out.txt" target="_blank">out</a> |
      <a href="/logs/live_paper.err.txt" target="_blank">err</a> |
      <a href="/api/summary" target="_blank">api</a>
    </div>
    <div class="mono" id="apiErr" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="mono"><b>Controls</b></div>
    <div class="row" style="margin-top:10px">
      <button onclick="post('/api/pause')">Pause</button>
      <button onclick="post('/api/resume')">Resume</button>
      <button onclick="post('/api/extend?seconds=3600')">Extend +60m</button>
      <button onclick="post('/api/stop')">Stop now</button>
    </div>
    <div class="mono" style="margin-top:10px">
      Auto-refresh:
      <label><input id="auto" type="checkbox" checked> ON</label>
      every <input id="sec" type="number" min="1" value="3" style="width:60px">s
      <button onclick="refresh()">Refresh</button>
    </div>
    <div class="mono" id="ctrlStatus" style="margin-top:10px">—</div>
  </div>

  <div class="card">
    <div class="mono"><b>Strategy stats (paper)</b></div>
    <div class="mono">Trades: <span id="trades">—</span></div>
    <div class="mono">Wins/Losses: <span id="wl">—</span></div>
    <div class="mono">Sum R: <span id="sumR">—</span></div>
    <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
    <div class="mono"><b>Last candle</b></div>
    <div class="mono">ts: <span id="lc_ts">—</span></div>
    <div class="mono">close: <span id="lc_close">—</span></div>
    <div class="mono">ema: <span id="lc_ema">—</span></div>
    <div class="mono">atr: <span id="lc_atr">—</span></div>
  </div>
</div>

<div class="row" style="margin-top:12px">
  <div class="card" style="flex:2;min-width:520px">
    <div class="mono"><b>Recent events</b> <small>(tail)</small></div>
    <table>
      <thead><tr><th style="width:180px">Time</th><th style="width:140px">Event</th><th>Details</th></tr></thead>
      <tbody id="events"></tbody>
    </table>
  </div>

  <div class="card" style="flex:1;min-width:360px">
    <div class="mono"><b>Last error</b></div>
    <div class="mono" id="lastErr" style="white-space:pre-wrap;margin-top:8px">—</div>
    <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
    <div class="mono"><b>Quick log tail (live_err)</b></div>
    <div class="mono" id="logTail" style="white-space:pre-wrap;margin-top:8px">—</div>
  </div>
</div>

<script>
const el=(id)=>document.getElementById(id);
const fmtTime=(ms)=>ms?new Date(Number(ms)).toLocaleString():"—";
const fmtRemain=(ms)=>{ if(ms<=0) return "00:00:00";
  const s=Math.floor(ms/1000);
  const hh=String(Math.floor(s/3600)).padStart(2,"0");
  const mm=String(Math.floor((s%3600)/60)).padStart(2,"0");
  const ss=String(s%60).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
};
async function api(path, method="GET"){
  const r=await fetch(path,{method,cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status} ${path}`);
  return await r.json();
}
async function post(path){
  el("ctrlStatus").textContent="sending…";
  try{ await api(path,"POST"); el("ctrlStatus").textContent="OK"; await refresh(); }
  catch(e){ el("ctrlStatus").textContent=String(e); }
}
async function refresh(){
  el("apiErr").textContent="";
  try{
    const s=await api("/api/summary");
    const now=Number(s.now_ms||0);
    const st=s.state||{};
    const ctrl=s.control||{};
    el("pid").textContent=s.live_paper_pid?String(s.live_paper_pid):"—";
    el("running").textContent=s.live_paper_running?"running":"stopped";
    el("paused").textContent=ctrl.paused?"YES":"NO";

    const dl=Number(st.run_deadline_ms||0);
    if(dl>0){ el("stopAt").textContent=fmtTime(dl); el("remain").textContent=fmtRemain(Math.max(0,dl-now)); }
    else { el("stopAt").textContent="no limit"; el("remain").textContent="—"; }

    el("health").className=s.live_paper_running?"ok":"bad";
    el("health").textContent=s.live_paper_running?"RUNNING":"STOPPED";

    const stats=(st.stats||{});
    el("trades").textContent=String(stats.trades ?? "—");
    el("wl").textContent=`${stats.wins ?? "—"} / ${stats.losses ?? "—"}`;
    el("sumR").textContent=String(stats.sum_R ?? "—");

    const lc=s.last_candle;
    el("lc_ts").textContent=lc?.candle_ts ? fmtTime(lc.candle_ts) : "—";
    el("lc_close").textContent=lc?.close ?? "—";
    el("lc_ema").textContent=lc?.ema ?? "—";
    el("lc_atr").textContent=lc?.atr ?? "—";

    const le=s.last_error;
    el("lastErr").textContent = le ? JSON.stringify(le,null,2) : "—";

    const items = (await api("/api/journal_tail?lines=25")).items || [];
    const tb = el("events"); tb.innerHTML="";
    for (let i=items.length-1;i>=0;i--){
      const it=items[i];
      const tr=document.createElement("tr");
      const t=it.ts?fmtTime(it.ts):"—";
      tr.innerHTML=`<td class="mono">${t}</td><td class="mono">${it.event||"—"}</td><td class="mono">${JSON.stringify(it)}</td>`;
      tb.appendChild(tr);
    }

    const lt = await api("/api/log_tail?which=live_err&lines=30");
    el("logTail").textContent = (lt.lines||[]).join("\n") || "—";
  }catch(e){
    el("health").className="warn"; el("health").textContent="API ERROR";
    el("apiErr").textContent=String(e);
  }
}

let timer=null;
function startTimer(){
  if(timer) clearInterval(timer);
  if(!el("auto").checked) return;
  const sec=Math.max(1, Number(el("sec").value||3));
  timer=setInterval(refresh, sec*1000);
}
el("auto").addEventListener("change", startTimer);
el("sec").addEventListener("change", startTimer);
refresh(); startTimer();
</script>
</body></html>
