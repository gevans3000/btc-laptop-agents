<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BTC Laptop Agents — Monitor</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:stretch; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px 14px; min-width:260px; flex:1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .ok { color:#0a7; font-weight:700; }
    .warn { color:#c60; font-weight:700; }
    button { padding:7px 10px; border-radius:12px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    button:hover { background:#fafafa; }
    table { border-collapse: collapse; width:100%; margin-top: 10px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top; }
    th { position: sticky; top:0; background:#fff; }
  </style>
</head>
<body>
  <h2>BTC Laptop Agents — Live Monitor</h2>

  <div class="row">
    <div class="card">
      <div class="mono"><span id="health" class="warn">CHECKING…</span></div>
      <div class="mono">Live PID: <span id="pid">—</span> (<span id="running">—</span>)</div>
      <div class="mono">Paused: <span id="paused">—</span></div>
      <div class="mono">Stops at: <span id="stopAt">—</span></div>
      <div class="mono">Remaining: <span id="remain" class="ok">—</span></div>
      <div class="mono" style="margin-top:8px;">
        <a href="/logs/live_paper.out.txt" target="_blank">out</a> |
        <a href="/logs/live_paper.err.txt" target="_blank">err</a> |
        <a href="/data/paper_state.json" target="_blank">state</a>
      </div>
    </div>

    <div class="card">
      <div class="mono"><b>Controls</b></div>
      <div class="row" style="margin-top:10px;">
        <button id="pauseBtn">Pause</button>
        <button id="resumeBtn">Resume</button>
        <button id="extendBtn">Extend +60m</button>
        <button id="stopBtn">Stop now</button>
      </div>
      <div class="mono" style="margin-top:10px;">
        Auto-refresh: <label><input id="auto" type="checkbox" checked> ON</label>
        every <input id="sec" type="number" min="1" value="3" style="width:60px">s
        <button id="refresh">Refresh</button>
      </div>
      <div class="mono" id="ctrlStatus" style="margin-top:10px;">—</div>
    </div>
  </div>

  <div class="row" style="margin-top:12px;">
    <div class="card">
      <div class="mono"><b>Recent journal events</b></div>
      <table>
        <thead><tr><th style="width:190px;">Time</th><th style="width:140px;">Event</th><th>Details</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
const el = (id)=>document.getElementById(id);
const fmtTime = (ms)=> ms ? new Date(Number(ms)).toLocaleString() : "—";
const fmtRemain = (ms)=>{
  if(ms <= 0) return "00:00:00";
  const s = Math.floor(ms/1000);
  const hh = String(Math.floor(s/3600)).padStart(2,"0");
  const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
};

async function api(path, method="GET"){
  const r = await fetch(path, {method, cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status} ${path}`);
  return await r.json();
}
async function fetchText(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status} ${url}`);
  return await r.text();
}
function summarize(o){
  const keys = ["msg","reason","error","side","entry","exit","R","close","ema","atr"];
  const parts=[];
  keys.forEach(k=>{ if(o[k] !== undefined) parts.push(`${k}=${o[k]}`); });
  return parts.join(" | ");
}

async function refresh(){
  const s = await api("/api/status");
  const state = s.state || {};
  const ctrl  = s.control || {};
  const now = Number(s.now_ms||0);

  el("pid").textContent = s.live_paper_pid ? String(s.live_paper_pid) : "—";
  el("running").textContent = s.live_paper_running ? "running" : "stopped";
  el("paused").textContent = ctrl.paused ? "YES" : "NO";

  const dl = Number(state.run_deadline_ms || 0);
  if(dl > 0){
    el("stopAt").textContent = fmtTime(dl);
    el("remain").textContent = fmtRemain(Math.max(0, dl - now));
  } else {
    el("stopAt").textContent = "no limit";
    el("remain").textContent = "—";
  }

  el("health").className = s.live_paper_running ? "ok" : "warn";
  el("health").textContent = s.live_paper_running ? "RUNNING" : "STOPPED";

  // journal tail
  let lines=[];
  try{
    const txt = await fetchText("/data/paper_journal.jsonl");
    lines = txt.split(/\r?\n/).filter(x=>x.trim().length>0).slice(-120);
  } catch(e) {}

  const rows=[];
  for(let i=lines.length-1;i>=0;i--){
    let o=null; try{ o=JSON.parse(lines[i]); }catch{ o={event:"raw", msg:lines[i]}; }
    rows.push(`<tr><td class="mono">${fmtTime(o.ts)}</td><td class="mono">${o.event||"—"}</td><td class="mono">${summarize(o)}</td></tr>`);
  }
  el("tbody").innerHTML = rows.join("") || `<tr><td colspan="3" class="mono">No journal yet.</td></tr>`;
}

async function post(path){
  el("ctrlStatus").textContent = "sending…";
  try{
    await api(path, "POST");
    el("ctrlStatus").textContent = "OK";
    await refresh();
  } catch(e){
    el("ctrlStatus").textContent = String(e);
  }
}

el("pauseBtn").addEventListener("click", ()=>post("/api/pause"));
el("resumeBtn").addEventListener("click", ()=>post("/api/resume"));
el("extendBtn").addEventListener("click", ()=>post("/api/extend?seconds=3600"));
el("stopBtn").addEventListener("click", ()=>post("/api/stop"));
el("refresh").addEventListener("click", refresh);

let timer=null;
function startTimer(){
  if(timer) clearInterval(timer);
  if(!el("auto").checked) return;
  const sec = Math.max(1, Number(el("sec").value||3));
  timer = setInterval(refresh, sec*1000);
}
el("auto").addEventListener("change", startTimer);
el("sec").addEventListener("change", startTimer);

refresh(); startTimer();
</script>
</body>
</html>
